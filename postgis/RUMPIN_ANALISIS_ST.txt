Jalankan perintah ini di QGIS > DB Manager > SQL Window:
Langkah 1: Tambahkan Kolom (Jika Belum Ada)
-- Pastikan kolom belum ada sebelum menjalankan ini
ALTER TABLE datagis."RUMPIN"
ADD COLUMN luas_cea double precision;
Langkah 2: Isi Nilai Luas (Hektar)
Setelah kolom berhasil ditambahkan, jalankan:
UPDATE datagis."RUMPIN"
SET luas_cea = ST_Area(ST_Transform(geom, 54034)) / 10000;

-- Jika kamu hanya butuh melihat data + luas tanpa menulis ke tabel:
CREATE OR REPLACE VIEW datagis.rumpin_with_luas AS
SELECT
  *,
  ST_Area(ST_Transform(geom, 54034)) / 10000 AS luas_cea
FROM datagis."RUMPIN";


-- Luas RUMPIN 
SELECT 
   a."nkws" AS "Nama Kawasan",        -- field nama
    SUM(
    ST_Area(
      ST_Transform(a.geom, 54034)   -- Proyeksi  ESRI CEA dengan satuan meter
    )
  ) / 10000 AS "LUAS_CEA_HA"        -- Total luas dalam hektar
FROM 
  "RUMPIN" a        -- Tabel Data IGT RUMPIN
WHERE 
  a.geom IS NOT NULL                   -- hanya geometri yang valid (tidak kosong) yang dihitung
GROUP BY 
  a."nkws"
ORDER BY
  a."nkws"

-- Tampilkan di QGIS
SELECT 
  a."nkws" AS "nama_kawasan",        
  ST_Union(a.geom) AS geom,  -- Gabungkan geometri per nkws
  SUM(
    ST_Area(
      ST_Transform(a.geom, 54034)
    )
  ) / 10000.0 AS "luas_cea_ha"
FROM 
  "RUMPIN" a        
WHERE 
  a.geom IS NOT NULL 
  AND ST_IsValid(a.geom)
GROUP BY 
  a."nkws"

--- Analisa Luasan PL di RUMPIN dengan KodePL
-- 1. Data utama per PL dan wilayah
SELECT
  c."NOURUT_PL",  
  COALESCE(c."DESKRIPSI_PL", 'TIDAK DIKETAHUI') AS "DESKRIPSI_PL",
  pl."pl2024_id",
  r."nkws" AS "WILAYAH",
  ROUND(
    (SUM(
      ST_Area(
        ST_Transform(
          ST_Intersection(pl.geom, r.geom),
          54034
        )
      )
    )::numeric) / 10000,
    2
  ) AS "LUAS_CEA_HA"
FROM 
  datagis."PL2024_AR_250K" pl
JOIN 
  datagis."RUMPIN" r ON ST_Intersects(pl.geom, r.geom)
LEFT JOIN 
  kodefikasi."KODE_PL" c ON pl."pl2024_id" = c."KD_PL"
GROUP BY 
  c."NOURUT_PL",
  c."DESKRIPSI_PL",
  pl."pl2024_id",
  r."nkws"

-- 2. Tambahkan baris total keseluruhan
UNION ALL

SELECT
  NULL AS "NOURUT_PL",
  'TOTAL SEMUA PL' AS "DESKRIPSI_PL",
  NULL AS "pl2024_id",
  NULL AS "WILAYAH",
  ROUND(
    (SUM(
      ST_Area(
        ST_Transform(
          ST_Intersection(pl.geom, r.geom),
          54034
        )
      )
    )::numeric) / 10000,
    2
  ) AS "LUAS_CEA_HA"
FROM 
  datagis."PL2024_AR_250K" pl
JOIN 
  datagis."RUMPIN" r ON ST_Intersects(pl.geom, r.geom)

ORDER BY
  "NOURUT_PL" NULLS LAST;


--- Analisa Luasan KWS di RUMPIN dengan KodeKWS
SELECT
  c."NOURUT_KWS",     -- Nomor urut dari master KODE_PL
  c."FUNGSI_KWS",
  COALESCE(c."FUNGSI_KWS", 'TIDAK DIKETAHUI') AS "FUNGSI_KWS",                            
  kws."FUNGSIKWS",    -- Kode KWS dari data KWS
  r."nkws",          -- Nama wilayah dari RUMPIN
  SUM(
    ST_Area(
      ST_Transform(
        ST_Intersection(kws.geom, r.geom),
        54034                                   -- Cylindrical Equal Area projection
      )
    )
  ) / 10000 AS "LUAS_CEA_HA"                    -- Luas dalam hektar
FROM 
  "KWSHUTAN_AR_250K_072024" kws
JOIN 
  "RUMPIN" r
    ON ST_Intersects(kws.geom, r.geom)
LEFT JOIN 
  "KODE_KWS" c
    ON kws."FUNGSIKWS" = c."KD_KWS"
--WHERE 
 -- ST_IsValid(kws.geom) AND ST_IsValid(r.geom) -- Hanya geom yg valid saja, akan beda jika digunakan 
 -- r."nkws" = 'RUMPIN'                        -- Filter wilayah, pastikan nama sesuai data
GROUP BY 
  kws."FUNGSIKWS",
  r."nkws",
  c."NOURUT_KWS",
  c."FUNGSI_KWS"
ORDER BY 
  c."NOURUT_KWS";


--- Analisa Luasan IGT LAHAN KRITIS di RUMPIN 
SELECT                         
  lk."kritis",       -- Kode kritis dari data IGT LAHAN_KRITIS_AR_50K_291124
  r."nkws",          -- Nama wilayah dari RUMPIN
  SUM(
    ST_Area(
      ST_Transform(
        ST_Intersection(lk.geom, r.geom),
        54034                                   -- Cylindrical Equal Area projection
      )
    )
  ) / 10000 AS "LUAS_CEA_HA"                    -- Luas dalam hektar
FROM 
  "LAHAN_KRITIS_AR_50K_291124" lk
JOIN 
  "RUMPIN" r
    ON ST_Intersects(lk.geom, r.geom)
--WHERE 
 -- ST_IsValid(lk.geom) AND ST_IsValid(r.geom) -- Hanya geom yg valid saja, akan beda jika digunakan 
 -- r."nkws" = 'RUMPIN'                        -- Filter wilayah, pastikan nama sesuai data
GROUP BY 
  lk."kritis",
  r."nkws"
ORDER BY r."nkws", lk."kritis"


-- Analisis Perubahan PL 22-24 di RUMPIN
SELECT
  pl22."pl2022_id",
  pl23."pl2023_id",
  pl24."pl2024_id",
  r."nkws",
  SUM(
    ST_Area(
      ST_Transform(
        ST_Intersection(
          ST_Intersection(
            ST_Intersection(pl22.geom, pl23.geom),
            pl24.geom
          ),
          r.geom
        ),
        54034
      )
    )
  ) / 10000 AS "LUAS_CEA_HA"
FROM 
  "PL2022_AR_250K" pl22
JOIN 
  "PL2023_AR_250K" pl23
    ON ST_Intersects(pl22.geom, pl23.geom)
JOIN 
  "PL2024_AR_250K" pl24
    ON ST_Intersects(pl23.geom, pl24.geom)
JOIN 
  "RUMPIN" r
    ON ST_Intersects(pl22.geom, r.geom)
   AND ST_Intersects(pl23.geom, r.geom)
   AND ST_Intersects(pl24.geom, r.geom)
GROUP BY    
  pl22."pl2022_id",
  pl23."pl2023_id",
  pl24."pl2024_id",
  r."nkws"
HAVING 
  SUM(
    ST_Area(
      ST_Transform(
        ST_Intersection(
          ST_Intersection(
            ST_Intersection(pl22.geom, pl23.geom),
            pl24.geom
          ),
          r.geom
        ),
        54034
      )
    )
  ) / 10000 != 0
ORDER BY 
  r."nkws",
  pl22."pl2022_id",
  pl23."pl2023_id",
  pl24."pl2024_id";

--- tambahkan result_geom utk QGIS
SELECT
  pl22."pl2022_id",
  pl23."pl2023_id",
  pl24."pl2024_id",
  r."nkws",
  
  -- Geometri hasil intersect 4 layer sebagai kolom spasial utama
  ST_Intersection(
    ST_Intersection(
      ST_Intersection(pl22.geom, pl23.geom),
      pl24.geom
    ),
    r.geom
  ) AS result_geom,

  -- Luas dalam hektar (menggunakan proyeksi equal area)
  SUM(
    ST_Area(
      ST_Transform(
        ST_Intersection(
          ST_Intersection(
            ST_Intersection(pl22.geom, pl23.geom),
            pl24.geom
          ),
          r.geom
        ),
        54034
      )
    )
  ) / 10000 AS "LUAS_CEA_HA"

FROM 
  "PL2022_AR_250K" pl22
JOIN 
  "PL2023_AR_250K" pl23
    ON ST_Intersects(pl22.geom, pl23.geom)
JOIN 
  "PL2024_AR_250K" pl24
    ON ST_Intersects(pl23.geom, pl24.geom)
JOIN 
  "RUMPIN" r
    ON ST_Intersects(pl22.geom, r.geom)
   AND ST_Intersects(pl23.geom, r.geom)
   AND ST_Intersects(pl24.geom, r.geom)

GROUP BY    
  pl22."pl2022_id",
  pl23."pl2023_id",
  pl24."pl2024_id",
  r."nkws",
  result_geom

HAVING 
  SUM(
    ST_Area(
      ST_Transform(
        ST_Intersection(
          ST_Intersection(
            ST_Intersection(pl22.geom, pl23.geom),
            pl24.geom
          ),
          r.geom
        ),
        54034
      )
    )
  ) / 10000 != 0

ORDER BY 
  r."nkws",
  pl22."pl2022_id",
  pl23."pl2023_id",
  pl24."pl2024_id";

