############
# API - Configuration for PostgREST.
############
# Stop docker and remove volumes:
docker compose down -v
# edit .env
PGRST_DB_SCHEMAS=public,storage,graphql_public,datagis
docker compose up -d

## setting waktu
alter database postgres

set timezone to 'Asia/Jakarta';

https://supabase.com/docs/guides/api/using-custom-schemas

CREATE SCHEMA datagis;
ALTER ROLE anon SET search_path = datagis, public, storage, graphql_public ;
GRANT USAGE ON SCHEMA datagis TO anon;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA datagis TO anon;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA datagis TO anon;
ALTER DEFAULT PRIVILEGES IN SCHEMA datagis
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO anon;
ALTER DEFAULT PRIVILEGES IN SCHEMA datagis
GRANT USAGE, SELECT ON SEQUENCES TO anon;
-- Supabase-specific: publish schema to GraphQL engine & REST
-- Publish schema datagis ke GraphQL API
GRANT USAGE ON SCHEMA datagis TO postgres;
GRANT SELECT ON ALL TABLES IN SCHEMA datagis TO postgres;
ALTER DEFAULT PRIVILEGES IN SCHEMA datagis
GRANT SELECT ON TABLES TO postgres;

### test API
GET https://xyzcompany.supabase.co/rest/v1/bangunan
GET https://domain/supabase-proxy/api/bangunan

### Pindahkan semua tabel di schema public ke schema datagis
DO
$$
DECLARE
    tbl RECORD;
BEGIN
    FOR tbl IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
    LOOP
        EXECUTE format('ALTER TABLE public.%I SET SCHEMA datagis;', tbl.tablename);
    END LOOP;
END
$$;

###  Beri Akses ke Role Supabase (anon)
GRANT USAGE ON SCHEMA datagis TO anon;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA datagis TO anon;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA datagis TO anon;



## Hapus SCHEMA
drop schema datagis cascade;

## Hapus Tabel dalam schema
do $$ declare
         r record;
begin
        for r in (select tablename from pg_tables where schemaname = 'datagis') loop
        execute 'drop table if exists ' || quote_ident(r.tablename) || ' cascade';
    end loop;
end $$;

### Akses SCHEMA
# Append /rest/v1/ to your URL, and then use the table name as the route.



### Pakai Script untuk dipakai berulang
-- 1. Buat schema 'datagis' jika belum ada
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.schemata WHERE schema_name = 'datagis'
    ) THEN
        EXECUTE 'CREATE SCHEMA datagis';
    END IF;
END $$;

-- 2. Set search_path untuk role 'anon' hanya jika belum sesuai
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_roles WHERE rolname = 'anon'
    ) THEN
        PERFORM 1;
        -- Tidak ada cara bawaan untuk cek nilai search_path, jadi kita set saja ulang
        EXECUTE 'ALTER ROLE anon SET search_path = public, storage, graphql_public, datagis';
    END IF;
END $$;

-- 3. Grant USAGE on schema ke role 'anon' (akan diabaikan jika sudah ada)
GRANT USAGE ON SCHEMA datagis TO anon;

-- 4. Grant akses penuh ke semua tabel yang sudah ada
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA datagis TO anon;

-- 5. Grant akses ke sequences yang sudah ada
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA datagis TO anon;

-- 6. Atur default privileges untuk tabel baru yang dibuat ke depan
ALTER DEFAULT PRIVILEGES IN SCHEMA datagis
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO anon;

-- 7. Atur default privileges untuk sequences baru yang dibuat ke depan
ALTER DEFAULT PRIVILEGES IN SCHEMA datagis
GRANT USAGE, SELECT ON SEQUENCES TO anon;

