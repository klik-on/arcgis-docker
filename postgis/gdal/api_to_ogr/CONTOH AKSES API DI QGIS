import requests
import json
from qgis.core import QgsVectorLayer, QgsProject, QgsFeature, QgsGeometry, QgsFields

# --- 1. KONFIGURASI ---
BASE_URL = "http://172.16.2.122:8000/api/v1/layers/datagis/KUPS"
HEADERS = {"X-API-TOKEN": "passwordnya disini"}
LIMIT = 5000
TOTAL_PAGES = 3  # Sesuaikan dengan hasil dari endpoint /stats

all_features = []
crs = "EPSG:4326"

print("üöÄ Memulai pengunduhan data KUPS...")

# --- 2. LOOPING DOWNLOAD ---
for page in range(1, TOTAL_PAGES + 1):
    url = f"{BASE_URL}?page={page}&limit={LIMIT}"
    print(f"üì• Mengunduh halaman {page}...")
    
    try:
        response = requests.get(url, headers=HEADERS)
        if response.status_code == 200:
            data = response.json()
            features = data.get("features", [])
            all_features.extend(features)
            print(f"‚úÖ Berhasil mengambil {len(features)} record.")
        else:
            print(f"‚ùå Gagal di halaman {page}: {response.status_code}")
    except Exception as e:
        print(f"‚ö†Ô∏è Error: {str(e)}")

# --- 3. PROSES PENGGABUNGAN KE QGIS ---
if all_features:
    # Buat GeoJSON lengkap dari semua fitur yang dikumpulkan
    full_geojson = {
        "type": "FeatureCollection",
        "name": "KUPS_Full_Data",
        "crs": { "type": "name", "properties": { "name": f"urn:ogc:def:crs:OGC:1.3:{crs}" } },
        "features": all_features
    }
    
    # Masukkan ke QGIS sebagai satu layer
    vlayer = QgsVectorLayer(json.dumps(full_geojson), "KUPS Gabungan API", "ogr")
    
    if vlayer.isValid():
        QgsProject.instance().addMapLayer(vlayer)
        print(f"‚ú® SELESAI! Total {len(all_features)} data berhasil digabungkan ke Map Canvas.")
    else:
        print("‚ùå Gagal membuat layer QGIS.")
else:
    print("‚ùå Tidak ada data yang berhasil diambil.")
