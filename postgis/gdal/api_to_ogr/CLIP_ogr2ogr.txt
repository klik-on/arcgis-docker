# Cek Data
ogrinfo "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" -so -al datagis."PL2024_AR_250K"
ogrinfo "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" -so -al datagis."ADM_KAB_KOTA"

# CLIP DATA POSTGIS
ogr2ogr -f "OpenFileGDB" output_clip.gdb \
  "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -nln hasil_clip \
  -nlt MULTIPOLYGON -skipfailures \
  --config OGR_ORGANIZE_POLYGONS SKIP \
  -clipsrc "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -clipsrclayer datagis."ADM_KAB_KOTA" \
  -clipsrcsql "SELECT ST_Union(geom) AS geom FROM datagis.\"ADM_KAB_KOTA\" WHERE \"WADMPR\" = 'Kalimantan Timur'" \
  -sql "SELECT ST_CollectionExtract(ST_MakeValid(geom), 3) AS geom, * FROM datagis.\"PL2024_AR_250K\"" \
  -progress \
  -overwrite

## Buat 2 Tahap untuk Stabil
ogr2ogr -f "PostgreSQL" PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -sql "SELECT ST_Multi(ST_MakeValid(ST_Union(geom))) AS geom, 'Kalimantan Timur' AS WADMPR FROM datagis.\"ADM_KAB_KOTA\" WHERE \"WADMPR\" = 'Kalimantan Timur'" \
  -nln clip_union -nlt MULTIPOLYGON -overwrite

ogrinfo PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" -so clip_union

ogr2ogr -f "PostgreSQL" PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -nln hasil_clip \
  -clipsrc PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -clipsrclayer clip_union \
  -nlt MULTIPOLYGON \
  -sql "SELECT * FROM datagis.\"PL2024_AR_250K\"" \
  -overwrite \
  -progress

### CLIP POSTGIS
-- Hapus tabel jika sudah ada sebelumnya
DROP TABLE IF EXISTS datagis.clip_pl_aceh;

-- Pastikan index untuk join ada (jika belum dibuat)
CREATE INDEX IF NOT EXISTS pl2024_id_idx
    ON datagis."PL2024_AR_250K" ("PL2024_ID");

CREATE INDEX IF NOT EXISTS kd_pl_idx
    ON kodefikasi."KODE_PL" ("KD_PL");  -- schema kodefikasi, tabel KODE_PL

-- Pastikan spatial index untuk geometri sumber ada
CREATE INDEX IF NOT EXISTS pl2024_geom_idx
    ON datagis."PL2024_AR_250K" USING GIST (geom);

CREATE INDEX IF NOT EXISTS adm_prov_geom_idx
    ON datagis."adm_provinsi_clean" USING GIST (geom);

-- Gunakan CTE untuk clipping, transformasi, dan hitung luas
WITH clipped AS (
    SELECT
        b."PL2024_ID",
        b.pl2023_id_r,
        a.nama_provinsi,
        a.kode_provinsi,
        k."KODE_PL",
        -- Hitung intersection dan buat geometri valid
        ST_CollectionExtract(ST_MakeValid(ST_Intersection(b.geom, a.geom)), 3) AS geom_intersect
    FROM datagis."PL2024_AR_250K" b
    JOIN datagis."adm_provinsi_clean" a
      ON ST_Intersects(a.geom, b.geom)
    LEFT JOIN kodefikasi."KODE_PL" k
      ON b."PL2024_ID" = k."KD_PL"
    WHERE a.kode_provinsi = '11'
),
transformed AS (
    SELECT
        *,
        -- Transform geometri ke Equal Area untuk perhitungan luas
        ST_Transform(ST_SetSRID(geom_intersect, 4326), 54034) AS geom_aea
    FROM clipped
)
-- Buat tabel final
CREATE TABLE datagis.clip_pl_aceh AS
SELECT
    "PL2024_ID",
    pl2023_id_r,
    nama_provinsi,
    kode_provinsi,
    "KODE_PL",
    ST_Area(geom_aea) / 10000 AS luas_ha, -- luas dalam hektar
    ST_SetSRID(geom_intersect, 4326) AS geom
FROM transformed
WHERE ST_IsValid(geom_intersect)
  AND ST_Area(geom_aea) > 0;

-- Tambahkan spatial index untuk tabel final
CREATE INDEX clip_pl_aceh_geom_idx
    ON datagis.clip_pl_aceh USING GIST (geom);

-- Index tambahan untuk join atau filter cepat
CREATE INDEX clip_pl_aceh_pl2024_id_idx
    ON datagis.clip_pl_aceh ("PL2024_ID");

-- Update statistik tabel agar planner PostgreSQL optimal
ANALYZE datagis.clip_pl_aceh;
