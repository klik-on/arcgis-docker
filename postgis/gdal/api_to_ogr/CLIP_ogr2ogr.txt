# Cek Data
ogrinfo "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" -so -al datagis."PL2024_AR_250K"
ogrinfo "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" -so -al datagis."ADM_KAB_KOTA"

# CLIP DATA POSTGIS
ogr2ogr -f "OpenFileGDB" output_clip.gdb \
  "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -nln hasil_clip \
  -nlt MULTIPOLYGON -skipfailures \
  --config OGR_ORGANIZE_POLYGONS SKIP \
  -clipsrc "PG:host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -clipsrclayer datagis."ADM_KAB_KOTA" \
  -clipsrcsql "SELECT ST_Union(geom) AS geom FROM datagis.\"ADM_KAB_KOTA\" WHERE \"WADMPR\" = 'Kalimantan Timur'" \
  -sql "SELECT ST_CollectionExtract(ST_MakeValid(geom), 3) AS geom, * FROM datagis.\"PL2024_AR_250K\"" \
  -progress \
  -overwrite

## Buat 2 Tahap untuk Stabil
ogr2ogr -f "PostgreSQL" PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -sql "SELECT ST_Multi(ST_MakeValid(ST_Union(geom))) AS geom, 'Kalimantan Timur' AS WADMPR FROM datagis.\"ADM_KAB_KOTA\" WHERE \"WADMPR\" = 'Kalimantan Timur'" \
  -nln clip_union -nlt MULTIPOLYGON -overwrite

ogrinfo PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" -so clip_union

ogr2ogr -f "PostgreSQL" PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -nln hasil_clip \
  -clipsrc PG:"host=172.16.2.122 dbname=postgres user=postgres.67888 password=password00" \
  -clipsrclayer clip_union \
  -nlt MULTIPOLYGON \
  -sql "SELECT * FROM datagis.\"PL2024_AR_250K\"" \
  -overwrite \
  -progress

### CLIP POSTGIS
-- 1️⃣ Aktifkan paralelisme (sesuaikan jumlah core server)
SET max_parallel_workers_per_gather = 4;
-- SET max_parallel_workers_per_gather = 8;  -- kalau server punya ≥ 8 core
SET work_mem = '256MB';
SET maintenance_work_mem = '512MB';


-- 2️⃣ Hapus tabel jika sudah ada sebelumnya
DROP TABLE IF EXISTS datagis.clip_pl_aceh;

-- 3️⃣ Buat tabel hasil clipping provinsi Aceh (kode_provinsi = '11')
--    Tambahkan kolom luas_ha (hektar) dan filter geometri valid serta luas > 0
CREATE TABLE datagis.clip_pl_aceh AS
SELECT
    b."PL2024_ID",
    b.pl2023_id_r,
    a.nama_provinsi,
    a.kode_provinsi,
    -- Hitung luas dalam hektar menggunakan proyeksi Equal Area (EPSG:54034)
    ST_Area(
        ST_Transform(
            ST_SetSRID(
                ST_CollectionExtract(
                    ST_MakeValid(ST_Intersection(b.geom, a.geom)),
                    3  -- 3 = POLYGON
                ),
                4326
            ),
            54034
        )
    ) / 10000 AS luas_ha,
    -- Simpan geometri valid dengan SRID 4326
    ST_SetSRID(
        ST_CollectionExtract(
            ST_MakeValid(ST_Intersection(b.geom, a.geom)),
            3
        ),
        4326
    ) AS geom
FROM datagis."PL2024_AR_250K" b
JOIN datagis."adm_provinsi_clean" a
  ON ST_Intersects(a.geom, b.geom)
WHERE a.kode_provinsi = '11'
  -- Pastikan geometri valid
  AND ST_IsValid(ST_Intersection(b.geom, a.geom))
  -- Hanya simpan fitur dengan luas > 0 hektar
  AND ST_Area(
        ST_Transform(
            ST_SetSRID(
                ST_CollectionExtract(
                    ST_MakeValid(ST_Intersection(b.geom, a.geom)),
                    3
                ),
                4326
            ),
            54034
        )
    ) > 0;

-- 4️⃣ Tambahkan spatial index agar query dan rendering QGIS cepat
CREATE INDEX clip_pl_aceh_geom_idx
    ON datagis.clip_pl_aceh USING GIST (geom);

-- 5️⃣ Jalankan ANALYZE untuk update statistik tabel
ANALYZE datagis.clip_pl_aceh;

### VERSI RINGAN
-- 1️⃣ Parallel & memori
SET max_parallel_workers_per_gather = 8;
SET work_mem = '256MB';

-- 2️⃣ Tabel provinsi Aceh (satu kali buat)
DROP TABLE IF EXISTS tmp_aceh_geom;
CREATE TEMP TABLE tmp_aceh_geom AS
SELECT geom, nama_provinsi, kode_provinsi
FROM datagis."adm_provinsi_clean"
WHERE kode_provinsi = '11';
CREATE INDEX tmp_aceh_geom_idx ON tmp_aceh_geom USING GIST (geom);
ANALYZE tmp_aceh_geom;

-- 3️⃣ Hapus tabel hasil lama
DROP TABLE IF EXISTS datagis.clip_pl_aceh;

-- 4️⃣ Buat tabel hasil clipping + luas hektar
CREATE TABLE datagis.clip_pl_aceh AS
SELECT
    b."PL2024_ID",
    b.pl2023_id_r,
    a.nama_provinsi,
    a.kode_provinsi,
    ST_Area(
        ST_Transform(
            ST_Intersection(b.geom, a.geom),
            54034
        )
    ) / 10000 AS luas_ha,
    ST_Intersection(b.geom, a.geom) AS geom
FROM datagis."PL2024_AR_250K" b
JOIN tmp_aceh_geom a
  ON a.geom && b.geom
 AND ST_Intersects(a.geom, b.geom)
WHERE ST_IsValid(b.geom)
  AND ST_Area(ST_Transform(b.geom, 54034)) > 0;

-- 5️⃣ Index dan analyze
CREATE INDEX clip_pl_aceh_geom_idx
    ON datagis.clip_pl_aceh USING GIST (geom);
ANALYZE datagis.clip_pl_aceh;





