-- Intersection 3 Tema
-- 1. Drop dan Buat Ulang Tabel dengan tipe yang sesuai
DROP TABLE IF EXISTS datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan";

CREATE TABLE datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan" (
  "NOURUT_PL" INT,
  "KODEPL" TEXT,
  "WADMPR" TEXT,
  "DESKRIPSI_PL" TEXT,
  "NOURUT_KWS" INT,
  "KODEKWS" TEXT,
  "FUNGSI_KWS" TEXT,
  "geom" GEOMETRY(POLYGON, 4326)  -- Tetap hanya menerima POLYGON
);

-- 2. Simpan hasil intersection geometris (POLYGON saja)
WITH luas_per_provinsi AS (
  SELECT
    c."NOURUT_PL",                         
    a."pl2024_id" AS "KODEPL",             
    b."WADMPR",                             
    c."DESKRIPSI_PL",                       
    e."NOURUT_KWS",
    d."FUNGSIKWS" AS "KODEKWS",
    e."FUNGSI_KWS",
    
    -- Gunakan ST_CollectionExtract untuk hanya ambil POLYGON (kode 3)
    ST_CollectionExtract(
      ST_Intersection(
        ST_MakeValid(a.geom),
        ST_Intersection(
          ST_MakeValid(b.geom),
          ST_MakeValid(d.geom)
        )
      ), 3
    ) AS geom

  FROM 
    datagis."PL2024_AR_250K" a
  INNER JOIN 
    datagis."ADM_KAB_KOTA" b ON ST_Intersects(a.geom, b.geom)
  INNER JOIN 
    datagis."KWSHUTAN_AR_250K" d ON ST_Intersects(a.geom, d.geom) 
  LEFT JOIN 
    kodefikasi."KODE_PL" c ON a."pl2024_id" = c."KD_PL"
  LEFT JOIN 
    kodefikasi."KODE_KWS" e ON d."FUNGSIKWS" = e."KD_KWS"
  WHERE 
    b."WADMPR" = 'DKI Jakarta'
)

-- 3. Masukkan hasilnya ke dalam tabel
INSERT INTO datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan" (
  "NOURUT_PL", 
  "KODEPL", 
  "WADMPR", 
  "DESKRIPSI_PL", 
  "NOURUT_KWS", 
  "KODEKWS", 
  "FUNGSI_KWS", 
  "geom"
)
SELECT 
  "NOURUT_PL",           
  "KODEPL",         
  "WADMPR",             
  "DESKRIPSI_PL",  
  "NOURUT_KWS",  
  "KODEKWS",  
  "FUNGSI_KWS", 
  (ST_Dump(geom)).geom  -- pastikan hasil pecahan koleksi bisa masuk ke kolom
FROM 
  luas_per_provinsi
WHERE 
  GeometryType(geom) IN ('POLYGON', 'MULTIPOLYGON');  -- Filter tambahan (opsional)

