-- Dissolve
CREATE TABLE datagis.ADM_PROVINSI_CLEAN AS
SELECT
  "WADMPR" AS nama_provinsi,
  ST_Union(ST_MakeValid(geom)) AS geom
FROM datagis."ADM_KAB_KOTA"
GROUP BY "WADMPR";

-- Intersection 3 Tema
-- 1. Drop dan Buat ulang tabel dengan tipe MULTIPOLYGON
DROP TABLE IF EXISTS datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan";

CREATE TABLE datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan" (
  "NOURUT_PL" INT,
  "KODEPL" TEXT,
  "WADMPR" TEXT,
  "DESKRIPSI_PL" TEXT,
  "NOURUT_KWS" INT,
  "KODEKWS" TEXT,
  "FUNGSI_KWS" TEXT,
  "geom" GEOMETRY(MULTIPOLYGON, 4326)  -- Ubah ke MULTIPOLYGON
);

-- 2. Simpan hasil intersection geometris dalam MULTIPOLYGON
WITH luas_per_provinsi AS (
  SELECT
    c."NOURUT_PL",                         
    a."pl2024_id" AS "KODEPL",             
    b."WADMPR",                             
    c."DESKRIPSI_PL",                       
    e."NOURUT_KWS",
    d."FUNGSIKWS" AS "KODEKWS",
    e."FUNGSI_KWS",

    -- Pastikan hasil akhir adalah MULTIPOLYGON
    ST_Multi(
      ST_CollectionExtract(
        ST_Intersection(
          a.geom,  -- Tidak lagi menggunakan ST_MakeValid()
          ST_Intersection(
            b.geom,  -- Tidak lagi menggunakan ST_MakeValid()
            d.geom   -- Tidak lagi menggunakan ST_MakeValid()
          )
        ), 3
      )
    ) AS geom

  FROM 
    datagis."PL2024_AR_250K" a
  INNER JOIN 
    datagis."ADM_KAB_KOTA" b ON ST_Intersects(a.geom, b.geom)
  INNER JOIN 
    datagis."KWSHUTAN_AR_250K" d ON ST_Intersects(a.geom, d.geom) 
  LEFT JOIN 
    kodefikasi."KODE_PL" c ON a."pl2024_id" = c."KD_PL"
  LEFT JOIN 
    kodefikasi."KODE_KWS" e ON d."FUNGSIKWS" = e."KD_KWS"
  
  -- Gunakan bounding box prefilter untuk mengurangi ruang pencarian
  WHERE 
    b."WADMPR" = 'DKI Jakarta'
    AND a.geom && b.geom   -- Bounding box filtering untuk PL2024 dan Kabupaten
    AND a.geom && d.geom   -- Bounding box filtering untuk PL2024 dan Fungsi Kawasan
)

-- 3. Insert hasilnya ke tabel output
INSERT INTO datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan" (
  "NOURUT_PL", 
  "KODEPL", 
  "WADMPR", 
  "DESKRIPSI_PL", 
  "NOURUT_KWS", 
  "KODEKWS", 
  "FUNGSI_KWS", 
  "geom"
)
SELECT 
  "NOURUT_PL",           
  "KODEPL",         
  "WADMPR",             
  "DESKRIPSI_PL",  
  "NOURUT_KWS",  
  "KODEKWS",  
  "FUNGSI_KWS", 
  geom
FROM 
  luas_per_provinsi
WHERE 
  geom IS NOT NULL;  -- Hindari error dari geometri kosong

-- 4. Membuat index GIST pada kolom geom di tabel output
CREATE INDEX ON datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan" USING GIST (geom);

-- 5. Verifikasi data yang telah disimpan
SELECT * FROM datagis."Luas_Penutupan_Lahan_Provinsi_Kawasan" LIMIT 10;


