-- Buat SCHEMA
CREATE SCHEMA kodefikasi;
ALTER SCHEMA kodefikasi OWNER TO postgres;
ALTER TABLE datagis."KODE_PL" SET SCHEMA kodefikasi;

-- Buat DISSOLVE
CREATE TABLE datagis.ADM_PROVINSI_CLEAN AS
SELECT
  "WADMPR" AS nama_provinsi,
  ST_Union(ST_MakeValid(geom)) AS geom
FROM datagis."ADM_KAB_KOTA"
GROUP BY "WADMPR";

-- Buat CLIP
-- Drop tabel jika sudah ada, kemudian buat ulang tabel
DROP TABLE IF EXISTS datagis.PL2020_BOGOR;

-- CLIP untuk PL 2020
CREATE TABLE datagis.PL2020_BOGOR AS (
  SELECT
    -- a.pl2020_id::text AS pl_id,
    a.pl2020_id,
    adm."WADMKK",
    ST_Intersection(a.geom, adm.geom) AS geom -- Menambahkan alias untuk hasil irisan geometri
  FROM 
    datagis."PL2020_AR_250K" a
  INNER JOIN datagis."ADM_KAB_KOTA" adm
    ON ST_Intersects(a.geom, adm.geom)
  WHERE adm."WADMKK" = 'Bogor'
);

-- Cek OVERLAP
SELECT a.id, b.id
FROM datagis."PBPH_DEFINITIF" a, datagis."PBPH_DEFINITIF" b
WHERE ST_Overlaps(a.geom, b.geom)
  AND a.id != b.id;
