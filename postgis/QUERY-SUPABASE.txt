-- Luas Fungsi Kawasan Hutan  Tanpa Batas Admin ####
SELECT 
  c."KD_KWS",
  c."FUNGSI_KWS",
  c."NOURUT_KWS",
  a."FUNGSIKWS",   
  SUM(ST_Area(ST_Transform(a.geom, 54034)))/10000 AS "LUAS_CEA"
FROM 
  "KWSHUTAN_AR_250K_072024" a  -- Tabel Data IGT Kawasan Hutan
LEFT JOIN 
  "KODE_KWS" c  -- Tabel Kodefikasi Kawasan
    ON a."FUNGSIKWS" = c."KD_KWS"
WHERE 
  a.geom IS NOT NULL -- hanya geometri yang valid (tidak kosong) yang dihitung
GROUP BY 
  a."FUNGSIKWS", c."KD_KWS", c."FUNGSI_KWS", c."NOURUT_KWS"
ORDER BY
  c."NOURUT_KWS";


-- Analisa Luas Kawasan Hutan Provinsi + Join Kodefiksi  ####
SELECT 
  a."FUNGSIKWS" AS "KODEKWS",
  b."WADMPR",
  c."FUNGSI_KWS",
  c."NOURUT_KWS",
  SUM(
    ST_Area(
      ST_Transform(
        ST_Intersection(a.geom, b.geom), 
        54034
      )
    )
  ) / 10000 AS "LUAS_CEA_HA"
FROM 
  "KWSHUTAN_AR_250K_072024" a
INNER JOIN 
  "ADM_KAB_KOTA" b 
   --  ON a.geom && b.geom AND ST_Intersects(a.geom, b.geom)   -- bounding box filter dulu
    ON ST_Intersects(a.geom, b.geom)  -- Sudah cukup tanpa && karena ST_Intersects mencakup itu
LEFT JOIN 
  "KODE_KWS" c 
    ON a."FUNGSIKWS" = c."KD_KWS"
WHERE 
  ST_IsValid(a.geom) 
  AND ST_IsValid(b.geom)
  AND b."WADMPR" = 'Bali'
GROUP BY 
  a."FUNGSIKWS",
  b."WADMPR",
  c."FUNGSI_KWS",
  c."NOURUT_KWS"
ORDER BY 
  c."NOURUT_KWS";


-- QUERY 3 TABEL DENGAN JOIN KODE FUNGSI ####
SELECT 
    a.nkws,
    b."FUNGSIKWS",
    c."WADMPR",
    c."WADMKK",
    k."FUNGSI_KWS",              -- kolom dari kode_kws
    SUM(
        ST_Area(
            ST_Transform(
                ST_MakeValid(
                    ST_Intersection(
                        ST_Intersection(a.geom, c.geom),
                        b.geom
                    )
                ),
                54034
            )
        )
    ) / 10000 AS luas_ha
FROM "RUMPIN" a
JOIN "ADM_KAB_KOTA" c 
    ON ST_Intersects(a.geom, c.geom)
JOIN "KWSHUTAN_AR_250K_072024" b 
    ON ST_Intersects(ST_Intersection(a.geom, c.geom), b.geom)
JOIN "KODE_KWS" k                      
    ON b."FUNGSIKWS" = k."KD_KWS"      
WHERE ST_Intersection(ST_Intersection(a.geom, c.geom), b.geom) IS NOT NULL
GROUP BY a.nkws, b."FUNGSIKWS", c."WADMPR", c."WADMKK", k."FUNGSI_KWS"
ORDER BY luas_ha DESC;

